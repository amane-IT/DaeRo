<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.daero.sns.mapper.SnsMapper">
    <select id="selectArticleAndTripInfoByArticleSeq" parameterType="_int" resultMap="mappingArticleVo">
        SELECT a.trips_seq, a.title, (SELECT COUNT(*)
                                     FROM likes l
                                     WHERE l.articles_seq=a.articles_seq
                                    ) AS like_count, (SELECT COUNT(*)
                                                      FROM replies r
                                                      WHERE r.articles_seq=a.articles_seq) AS reply_count, (SELECT t.users_seq
                                                                                                            FROM trips t
                                                                                                            WHERE t.trips_seq=a.trips_seq) AS user_seq,
               (SELECT t.trip_comment
                FROM trips t
                WHERE t.trips_seq=a.trips_seq) AS trip_comment, (SELECT t.trip_expenses
                                                                 FROM trips t
                                                                 WHERE t.trips_seq=a.trips_seq) AS trip_expenses, (SELECT t.trip_rating
                                                                                                                   FROM trips t
                                                                                                                   WHERE t.trips_seq=a.trips_seq) AS trip_rating
        FROM articles a
        WHERE articles_seq=#{articleSeq}
    </select>

    <select id="selectStampAndDayInfoByTripSeq" parameterType="_int" resultMap="mappingStampVo">
        SELECT td.trip_days_seq, td.date, td.day_comment, ts.image_url, ts.trip_stamps_seq, tp.latitude, tp.longitude
        FROM trip_days td
                 LEFT JOIN trip_stamps ts on td.trip_days_seq = ts.trip_days_seq
                 LEFT JOIN trip_places tp on ts.trip_places_seq = tp.trip_places_seq
        WHERE td.trips_seq=#{tripSeq}
    </select>

    <select id="selectUserByUserSeq" parameterType="_int" resultType="java.util.Map">
        SELECT u.nickname, u.profile_image_link
        FROM users u
        WHERE users_seq=#{userSeq}
    </select>

    <select id="selectPlaceTagsByArticleSeq" parameterType="_int" resultType="_int">
        SELECT place_tag_seq
        FROM article_tags
        WHERE articles_seq=#{articleSeq}
    </select>

    <resultMap id="mappingArticleVo" type="com.ssafy.daero.sns.vo.ArticleVo">
        <result property="tripSeq" column="trips_seq" />
        <result property="userSeq" column="user_seq" />
        <result property="title" column="title" />
        <result property="tripComment" column="trip_comment" />
        <result property="tripExpenses" column="trip_expenses" />
        <result property="rating" column="trip_rating" />
        <result property="likes" column="like_count" />
        <result property="comments" column="reply_count" />
    </resultMap>

    <resultMap id="mappingStampVo" type="com.ssafy.daero.sns.vo.StampVo">
        <result property="imageUrl" column="image_url" />
        <result property="tripDaySeq" column="trip_days_seq"/>
        <result property="tripStampSeq" column="trip_stamps_seq" />
        <result property="latitude" column="latitude" />
        <result property="longitude" column="longitude" />
        <result property="datetime" column="date" />
        <result property="dayComment" column="day_comment" />
    </resultMap>
</mapper>